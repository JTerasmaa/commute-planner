<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stop Departures (JSONP Demo)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100">
  <div class="max-w-lg mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4">Departure Times by Stop</h1>
    <div class="mb-4">
      <label class="block mb-1 font-medium" for="stop-input">Stop name (exact):</label>
      <input id="stop-input" class="w-full p-2 border rounded" value="NÃµmme" />
    </div>
    <div class="mb-4">
      <label class="block mb-1 font-medium" for="mode-select">Mode:</label>
      <select id="mode-select" class="w-full p-2 border rounded">
        <option value="train">Train</option>
        <option value="tram">Tram</option>
      </select>
    </div>
    <button id="load-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Load Departures</button>
    <p id="status" class="mt-4 text-gray-600"></p>
    <div id="error" class="text-red-500 mt-2"></div>
    <ul id="departures-list" class="list-disc list-inside bg-white p-4 rounded shadow mt-4"></ul>
  </div>

  <script>
    const API_BASE = 'https://peatus.ee/api/departures';
    const WINDOW_MS = 2 * 3600 * 1000;

    function loadJSONP(stop, mode, callbackName) {
      return new Promise((resolve, reject) => {
        window[callbackName] = data => {
          cleanup();
          if (!Array.isArray(data)) return reject(new Error('Invalid JSONP payload'));
          resolve(data);
        };
        const script = document.createElement('script');
        script.src = `${API_BASE}?stop=${encodeURIComponent(stop)}&mode=${mode}&callback=${callbackName}`;
        script.onerror = () => { cleanup(); reject(new Error('Network error loading JSONP')); };
        function cleanup() {
          delete window[callbackName];
          document.body.removeChild(script);
        }
        document.body.appendChild(script);
      });
    }

    function displayDepartures(data) {
      const now = Date.now();
      const listEl = document.getElementById('departures-list');
      listEl.innerHTML = '';
      const times = data.map(item => item.time).filter(t => {
        const [h,m] = t.split(':').map(Number);
        const dt = new Date(now);
        dt.setHours(h, m, 0, 0);
        return dt >= now && dt <= now + WINDOW_MS;
      });
      [...new Set(times)].forEach(t => {
        const li = document.createElement('li'); li.textContent = t; listEl.appendChild(li);
      });
      if (!listEl.children.length) {
        const li = document.createElement('li'); li.textContent = 'No upcoming departures'; li.className='text-gray-500'; listEl.appendChild(li);
      }
    }

    document.getElementById('load-btn').addEventListener('click', async () => {
      const stop = document.getElementById('stop-input').value.trim();
      const mode = document.getElementById('mode-select').value;
      const statusEl = document.getElementById('status');
      const errorEl = document.getElementById('error');
      statusEl.textContent = 'Loading...';
      errorEl.textContent = '';
      try {
        const data = await loadJSONP(stop, mode, 'cb' + Date.now());
        displayDepartures(data);
      } catch (e) {
        errorEl.textContent = e.message;
      } finally {
        statusEl.textContent = '';
      }
    });
  </script>
</body>
</html>
