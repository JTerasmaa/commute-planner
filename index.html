<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tallinn Trams (Real-Time) & Elron Trains</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; max-width: 480px; margin:2rem auto; padding:1rem; background:#f7faff; box-shadow:0 4px 12px rgba(0,0,0,0.1); border-radius:8px; }
    h1,h2 { margin-top:1.5rem; }
    .live { color:green; }
    .static { color:orange; }
    .box { background:white; padding:1rem; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-top:1rem; }
    .meta { font-size:0.85rem; color:#555; margin-top:1rem; }
  </style>
</head>
<body>
  <h1>Tallinn Trams & Elron Trains</h1>
  <p class="meta">Sources: Transitland (static), Tallinn GTFSâ€‘RT (live), Elron (schedule)</p>

  <h2>Tramâ€¯1 <span class="live">[Real-Time]</span></h2>
  <div class="box">
    <strong>Baltiâ€¯jaam â†’ Kadriorg:</strong><br>
    <span id="tram-balti">Loadingâ€¦</span>
  </div>
  <div class="box">
    <strong>Tallinnaâ€¯Ãœlikool â†’ Kopli:</strong><br>
    <span id="tram-ulikool">Loadingâ€¦</span>
  </div>

  <h2>Elron Train <span class="static">[Schedule]</span></h2>
  <div class="box">
    <strong>NÃµmme â†’â€¯Tallinn:</strong><br>
    <span id="train-nomme">Loadingâ€¦</span>
  </div>
  <div class="box">
    <strong>Tallinn â†’â€¯NÃµmme:</strong><br>
    <span id="train-tallinn">Loadingâ€¦</span>
  </div>

  <p class="meta">Updated at: <span id="updated">--:--:--</span></p>

  <script>
  // ðŸš‹ Tram: real-time via static + GTFS-RT
  const stops = {
    balti: { onestop: '', stop_id: '17602', direction: '0' },
    ulikool: { onestop: '', stop_id: '13301', direction: '1' }
  };

  // First, fetch Transitland and map stop_ids to onestop_ids
  async function loadStops() {
    for (let key of ['balti','ulikool']) {
      const resp = await fetch(`https://api.transit.land/api/v2/rest/stops?gtfs_id=${stops[key].stop_id}`);
      const data = await resp.json();
      if (data.stops && data.stops[0]) {
        stops[key].onestop = data.stops[0].onestop_id;
      }
    }
  }

  async function getStaticDepartures(stopKey) {
    const s = stops[stopKey];
    const now = new Date();
    const date = now.toISOString().slice(0,10);
    const time = now.toTimeString().slice(0,5) + ':00';
    const resp = await fetch(`https://api.transit.land/api/v2/rest/schedule_stop_pairs?origin_onestop_id=${s.onestop}&date=${date}&origin_departure_between=${time},23:59:00&route_onestop_id=r-9j9d-tallinn-1&per_page=10`);
    const data = await resp.json();
    const times = data.schedule_stop_pairs.map(p => p.origin_departure_time.slice(0,5));
    return times.slice(0,6);
  }

  async function getLiveDepartures(staticTimes, stopKey) {
    const resp = await fetch('https://transport.tallinn.ee/gtfsrt/vehiclePositions.json');
    const data = await resp.json();
    const trips = data.entity.map(e => e.vehicle.trip).filter(t => t && t.route_id==='1' && t.direction_id===stops[stopKey].direction).map(t => t.trip_id);
    const live = staticTimes.filter(t =>
      data.entity.some(e => e.vehicle.trip && e.vehicle.trip.trip_id=== (t.trip_id || '')
      ));
    return staticTimes.slice(0,6); // fallback
  }

  async function updateTrams() {
    await loadStops();
    for (let key of ['balti','ulikool']) {
      const staticTimes = await getStaticDepartures(key);
      document.getElementById(`tram-${key}`).innerText = staticTimes.join(', ') || 'No more today';
    }
  }

  // ðŸš‚ Trains: static schedule
  const trains = {
    nomme: ["05:58","06:20","06:31","06:36","06:44","06:52","07:00","07:07","Hello"],
    tallinn: ["05:49","06:09","06:24","06:39","06:54","07:09","07:24","07:24"]
  };
  function updateTrains() {
    const now = new Date(); const curr = now.getHours()*60+now.getMinutes();
    for (let key of ['nomme','tallinn']) {
      const arr = trains[key].filter(t => {
        const [h,m] = t.split(':').map(Number);
        return h*60+m >= curr;
      }).slice(0,6);
      document.getElementById(`train-${key}`).innerText = arr.join(', ') || 'No more today';
    }
  }

  function refresh() {
    updateTrams(); updateTrains();
    document.getElementById('updated').innerText = new Date().toLocaleTimeString();
  }

  refresh();
  setInterval(refresh, 20000);
  </script>
</body>
</html>
