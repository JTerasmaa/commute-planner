<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸš† Sinna ja tagasi</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#333; min-height:100vh;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 5px;
    }
    .header { text-align:center; margin-bottom:20px; color:white; }
    .header h1 { font-size:2.5rem; text-shadow:2px 2px 4px rgba(0,0,0,0.3); }
    .current-time { font-size:1.2rem; opacity:.9; margin-top:10px; }
    .direction-toggle { display:flex; justify-content:center; gap:10px; margin:20px 0; }
    .toggle-btn {
      background:rgba(255,255,255,0.2); border:2px solid white; color:white;
      padding:12px 24px; border-radius:25px; cursor:pointer; font-weight:600;
      transition:background .3s;
    }
    .toggle-btn.active { background:white; color:#667eea; }
    .toggle-btn:hover { background:rgba(255,255,255,0.3); }
    .paired-section { background:white; border-radius:15px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
    .paired-header { display:grid; grid-template-columns:1fr 1fr; align-items:center; margin-bottom:10px; }
    .paired-header .col { display:flex; align-items:center; gap:10px; }
    .route-icon { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:1rem; }
    .train-icon { background:#2196F3; }
    .tram-icon  { background:#FF9800; }
    .paired-departures {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .paired-cell { display:flex; flex-direction:column; gap:5px; }
    .departure-card { background:#f8f9fa; border-radius:8px; padding:8px; border-left:4px solid #667eea; }
    .departure-card.next-departure { border-left-color:#4CAF50; background:#e8f5e8; }
    .departure-card.soon { border-left-color:#FF9800; background:#fff3e0; }
    .departure-card.highlight { background:#fffde7; border-left-color:#fdd835; }
    .departure-time { font-size:1rem; font-weight:bold; color:#2196F3; }
    .countdown { font-size:.8rem; font-weight:bold; color:#FF9800; }
    .no-data { text-align:center; color:#666; font-style:italic; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸš† Sinna ja tagasi</h1>
      <div class="current-time" id="currentTime"></div>
    </div>
    <div class="direction-toggle">
      <button class="toggle-btn active" id="morningBtn" onclick="setDirection('morning')">ðŸŒ… Sinna</button>
      <button class="toggle-btn" id="eveningBtn" onclick="setDirection('evening')">ðŸŒ† Tagasi</button>
    </div>

    <div id="pairedRoutes"><!-- paired section injected here --></div>
  </div>

  <script>
    // Static schedule data
    const SCHEDULE_DATA = { /* existing tramSchedule and trainSchedule */ };
    // Highlight specific weekday-only trains
    const highlight = {
      'train-morning': [
        '05:01','05:42','06:12','07:12','07:21','07:32','07:52','08:12','08:32',
        '15:51','16:31','17:32','17:52'
      ],
      'train-evening': [
        '06:15','06:35','07:36','08:15','08:35','08:55',
        '16:16','16:36','16:56','17:16','18:15'
      ]
    };

    let currentDirection = 'morning';

    function pad(n) { return n.toString().padStart(2,'0'); }
    function isWeekend() { const d=new Date().getDay(); return d===0||d===6; }
    function isWeekday() { return !isWeekend(); }

    function getStaticTimes(id) {
      if (id.startsWith('tram')) {
        const key = id==='tram-morning'
          ? 'Balti Jaam â†’ Tallinna Ãœlikool'
          : 'Tallinna Ãœlikool â†’ Balti Jaam';
        const block = SCHEDULE_DATA.tramSchedule[key];
        const period = isWeekend() ? block.weekends : block.weekdays;
        const times = [];
        Object.entries(period).forEach(([hr, mins]) => mins.forEach(m => times.push(`${pad(hr)}:${pad(m)}`)));
        return times.sort();
      } else {
        const key = id==='train-morning'
          ? 'NÃµmme â†’ Tallinn'
          : 'Tallinn â†’ NÃµmme';
        return SCHEDULE_DATA.trainSchedule[key];
      }
    }

    function generateUpcoming(id) {
      const times = getStaticTimes(id);
      const now = new Date();
      const nowMin = now.getHours()*60 + now.getMinutes();
      return times.map(t => {
        const [h,m] = t.split(':').map(Number);
        let mins = h*60 + m;
        if (mins < nowMin) mins += 1440;
        return { time: t, diff: mins - nowMin };
      }).sort((a,b) => a.diff - b.diff);
    }

    function pairDepartures(primaryId, secondaryId, minGap) {
      const prim = generateUpcoming(primaryId);
      const sec = generateUpcoming(secondaryId);
      const pairs = [];
      let j = 0;
      for (const p of prim) {
        while (j < sec.length && sec[j].diff < p.diff + minGap) j++;
        const s = sec[j] || { time: 'â€”', diff: 'â€“' };
        pairs.push({ p, s });
      }
      return pairs.slice(0,6);
    }

    function formatCell(item, routeId) {
      if (item.time === 'â€”') return '<div class="no-data">â€”</div>';
      const cls = ['departure-card'];
      if (item.diff <= 5) cls.push('soon');
      if (routeId.startsWith('train') && isWeekday() && highlight[routeId].includes(item.time)) cls.push('highlight');
      if (item === generateUpcoming(routeId)[0]) cls.push('next-departure');
      return `
        <div class="${cls.join(' ')}">
          <div class="departure-time">${item.time}</div>
          <div class="countdown">${item.diff} min</div>
        </div>`;
    }

    function renderPaired() {
      const container = document.getElementById('pairedRoutes');
      let html = '';
      if (currentDirection === 'morning') {
        const pairs = pairDepartures('train-morning','tram-morning',14);
        html += `<div class="paired-section">
          <div class="paired-header">
            <div class="col"><div class="route-icon train-icon">ðŸš†</div><h3>Rong</h3></div>
            <div class="col"><div class="route-icon tram-icon">1</div><h3>Tramm</h3></div>
          </div>
          <div class="paired-departures">
            ${pairs.map(({p,s}) => `
              <div class="paired-cell">${formatCell(p,'train-morning')}</div>
              <div class="paired-cell">${formatCell(s,'tram-morning')}</div>
            `).join('')}
          </div>
        </div>`;
      } else {
        const pairs = pairDepartures('tram-evening','train-evening',14);
        html += `<div class="paired-section">
          <div class="paired-header">
            <div class="col"><div class="route-icon tram-icon">1</div><h3>Tramm</h3></div>
            <div class="col"><div class="route-icon train-icon">ðŸš†</div><h3>Rong</h3></div>
          </div>
          <div class="paired-departures">
            ${pairs.map(({p,s}) => `
              <div class="paired-cell">${formatCell(p,'tram-evening')}</div>
              <div class="paired-cell">${formatCell(s,'train-evening')}</div>
            `).join('')}
          </div>
        </div>`;
      }
      container.innerHTML = html;
    }

    function setDirection(dir) {
      currentDirection = dir;
      document.getElementById('morningBtn').classList.toggle('active', dir === 'morning');
      document.getElementById('eveningBtn').classList.toggle('active', dir === 'evening');
      renderPaired();
    }

    document.addEventListener('DOMContentLoaded', () => {
      setInterval(() => {
        document.getElementById('currentTime').textContent =
          new Date().toLocaleTimeString('et-EE', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      }, 1000);
      renderPaired();
    });
  </script>
</body>
</html>
