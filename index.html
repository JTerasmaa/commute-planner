<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tallinn Tram 1 – Live Timetables</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui,sans-serif; background: #f7faff; max-width: 440px; margin: 2em auto; padding: 1.2em; border-radius: 14px; box-shadow: 0 4px 16px #0002;}
    h1 { font-size: 1.25em; }
    select, button { font-size: 1em; margin: 0.6em 0 1em 0; padding: 0.35em 0.6em;}
    #times { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px #0001; padding: 1em; margin-top: 1em;}
    .meta { font-size: .87em; color: #888; margin-top: 2em;}
    @media (max-width: 600px) { body { margin:0.5em; padding:0.5em; } }
  </style>
</head>
<body>
  <h1>Tallinn Tram 1 Timetable (Live)</h1>

  <label>
    Direction:<br>
    <select id="direction">
      <option value="A">Kopli → Kadriorg</option>
      <option value="B">Kadriorg → Kopli</option>
    </select>
  </label>
  <br>
  <label>
    Stop:<br>
    <select id="stop"></select>
  </label>
  <div id="times">Loading…</div>

  <div class="meta">
    Source: <a href="https://viimane.info/" target="_blank">viimane.info (Tallinna Transport API)</a> <br>
    <span id="lastupdate"></span>
  </div>

  <script>
    // Line 1, directions: A (Kopli->Kadriorg), B (Kadriorg->Kopli)
    const LINE_ID = 1; // Tram 1
    const API = "https://api.viimane.info";
    const directionNames = {
      A: "Kopli → Kadriorg",
      B: "Kadriorg → Kopli"
    };

    // 1. Get all stops for tram 1 and both directions
    let stopsByDir = {};
    let stopIdToName = {};

    async function fetchStops() {
      for (const dir of ['A','B']) {
        const res = await fetch(`${API}/lines/${LINE_ID}/${dir}/stops`);
        const stops = await res.json();
        stopsByDir[dir] = stops.map(s => ({
          id: s.stop_id,
          name: s.stop_name
        }));
        stops.forEach(s => stopIdToName[s.stop_id] = s.stop_name);
      }
    }

    // 2. Populate direction and stop dropdowns
    function populateStops(direction) {
      const stopSel = document.getElementById('stop');
      stopSel.innerHTML = "";
      for (const stop of stopsByDir[direction]) {
        let opt = document.createElement('option');
        opt.value = stop.id;
        opt.textContent = stop.name;
        stopSel.appendChild(opt);
      }
    }

    // 3. Fetch departures for selected stop & direction
    async function updateTimes() {
      const direction = document.getElementById('direction').value;
      const stopId = document.getElementById('stop').value;
      const timesDiv = document.getElementById('times');

      timesDiv.innerHTML = "Loading…";
      try {
        const res = await fetch(`${API}/departures/${stopId}?line_id=${LINE_ID}&direction=${direction}`);
        const data = await res.json();

        // Departures are in UNIX seconds
        const now = Date.now() / 1000;
        const upcoming = data.departures
          .filter(dep => dep.departure_time >= now)
          .slice(0, 8)
          .map(dep => {
            const d = new Date(dep.departure_time * 1000);
            return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
          });

        timesDiv.innerHTML = `<b>Next departures from <span>${stopIdToName[stopId]}</span>:</b><br>
          ${upcoming.length ? upcoming.join(', ') : 'No more trams today.'}`;
        document.getElementById('lastupdate').textContent =
          "Updated: " + new Date().toLocaleTimeString();
      } catch (e) {
        timesDiv.innerHTML = "Error loading timetable. Please try again.";
      }
    }

    // 4. Setup event handlers and initialise
    document.getElementById('direction').addEventListener('change', async function() {
      populateStops(this.value);
      await updateTimes();
    });
    document.getElementById('stop').addEventListener('change', updateTimes);

    // 5. Load everything
    (async function init() {
      await fetchStops();
      populateStops('A');
      await updateTimes();
    })();
  </script>
</body>
</html>
